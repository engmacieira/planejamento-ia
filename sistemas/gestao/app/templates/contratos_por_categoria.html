{% extends "base.html" %}
{% from '_pagination.html' import render_pagination with context %}

{% block title %}Catálogo - {{ categoria.nome }}{% endblock %}

{% block content %}

{% include '_contratos_por_categoria_header.html' %}

<div class="card full-width">

    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th class="sortable-header" style="width: 40%;">
                        {% set next_order_desc = 'desc' if sort_by == 'descricao' and order == 'asc' else 'asc' %}
                        {% set params_desc = query_params.copy() %}
                        {% set _ = params_desc.update({'sort_by': 'descricao', 'order': next_order_desc}) %}
                        {% set base_path_desc = request.app.url_path_for('contratos_por_categoria', id_categoria=categoria.id) %}
                        {% set query_parts_desc = [] %}{% for key, value in params_desc.items() if value is not none and value != '' %}{% set _ = query_parts_desc.append(key ~ '=' ~ (value|string)) %}{% endfor %}{% set query_string_desc = "?" ~ (query_parts_desc | join('&')) if query_parts_desc else "" %}
                        <a href="{{ base_path_desc }}{{ query_string_desc }}">
                            Descrição do Item
                            {% if sort_by == 'descricao' %}<i class="fa-solid {{ 'fa-arrow-down-z-a' if order == 'desc' else 'fa-arrow-up-a-z' }}"></i>{% endif %}
                        </a>
                    </th>
                    <th class="sortable-header">
                        {% set next_order_cont = 'desc' if sort_by == 'contrato' and order == 'asc' else 'asc' %}
                        {% set params_cont = query_params.copy() %}
                        {% set _ = params_cont.update({'sort_by': 'contrato', 'order': next_order_cont}) %}
                        {% set base_path_cont = request.app.url_path_for('contratos_por_categoria', id_categoria=categoria.id) %}
                        {% set query_parts_cont = [] %}{% for key, value in params_cont.items() if value is not none and value != '' %}{% set _ = query_parts_cont.append(key ~ '=' ~ (value|string)) %}{% endfor %}{% set query_string_cont = "?" ~ (query_parts_cont | join('&')) if query_parts_cont else "" %}
                        <a href="{{ base_path_cont }}{{ query_string_cont }}">
                            Instrumento Contratual de Origem
                            {% if sort_by == 'contrato' %}<i class="fa-solid {{ 'fa-arrow-down-z-a' if order == 'desc' else 'fa-arrow-up-a-z' }}"></i>{% endif %}
                        </a>
                    </th>
                    <th class="text-right">Qtd. Contratada</th>
                    <th class="text-right">Qtd. Pedida</th>
                    <th class="sortable-header text-green text-right">
                        {% set next_order_saldo = 'desc' if sort_by == 'saldo' and order == 'asc' else 'asc' %}
                        {% set params_saldo = query_params.copy() %}
                        {% set _ = params_saldo.update({'sort_by': 'saldo', 'order': next_order_saldo}) %}
                        {% set base_path_saldo = request.app.url_path_for('contratos_por_categoria', id_categoria=categoria.id) %}
                        {% set query_parts_saldo = [] %}{% for key, value in params_saldo.items() if value is not none and value != '' %}{% set _ = query_parts_saldo.append(key ~ '=' ~ (value|string)) %}{% endfor %}{% set query_string_saldo = "?" ~ (query_parts_saldo | join('&')) if query_parts_saldo else "" %}
                        <a href="{{ base_path_saldo }}{{ query_string_saldo }}">
                            Saldo Disponível
                            {% if sort_by == 'saldo' %}<i class="fa-solid {{ 'fa-arrow-down-1-9' if order == 'desc' else 'fa-arrow-up-9-1' }}"></i>{% endif %}
                        </a>
                    </th>
                    <th class="sortable-header text-right">
                        {% set next_order_valor = 'desc' if sort_by == 'valor' and order == 'asc' else 'asc' %}
                        {% set params_valor = query_params.copy() %}
                        {% set _ = params_valor.update({'sort_by': 'valor', 'order': next_order_valor}) %}
                        {% set base_path_valor = request.app.url_path_for('contratos_por_categoria', id_categoria=categoria.id) %}
                        {% set query_parts_valor = [] %}{% for key, value in params_valor.items() if value is not none and value != '' %}{% set _ = query_parts_valor.append(key ~ '=' ~ (value|string)) %}{% endfor %}{% set query_string_valor = "?" ~ (query_parts_valor | join('&')) if query_parts_valor else "" %}
                        <a href="{{ base_path_valor }}{{ query_string_valor }}">
                            Valor Unit. (R$)
                            {% if sort_by == 'valor' %}<i class="fa-solid {{ 'fa-arrow-down-1-9' if order == 'desc' else 'fa-arrow-up-9-1' }}"></i>{% endif %}
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% if itens %}
                    {% for item in itens %}
                    <tr>
                        <td><strong>{{ item.descricao }}</strong></td>
                        <td><a href="{{ request.app.url_path_for('detalhe_contrato', id_contrato=item.id_contrato) }}">{{ item.numero_contrato }}</a></td>

                        <td class="text-right">{% if item.quantidade == item.quantidade|int %}{{ item.quantidade|int }}{% else %}{{ (item.quantidade | round(2) | string) | replace('.', ',') }}{% endif %}</td>

                        <td class="text-right">{% if item.total_pedido == item.total_pedido|int %}{{ item.total_pedido|int }}{% else %}{{ (item.total_pedido | round(2) | string) | replace('.', ',') }}{% endif %}</td>

                        <td class="text-right {{ 'text-red' if item.saldo == 0 else 'text-green' }}" style="font-weight: 700;">
                            {% if item.saldo == item.saldo|int %}{{ item.saldo|int }}{% else %}{{ (item.saldo | round(2) | string) | replace('.', ',') }}{% endif %}
                        </td>

                        <td class="text-right">{{ (item.valor_unitario | round(2) | string) | replace('.', ',') }}</td>
                    </tr>
                    {% else %} 
                    <tr><td colspan="6"><div class="empty-state mini"><p>Nenhum item encontrado para esta categoria ou filtro.</p></div></td></tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="card-footer">

    </div>
</div>
{% endblock %}