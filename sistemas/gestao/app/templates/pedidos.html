{% extends "base.html" %}
{% from '_pagination.html' import render_pagination with context %}

{% block title %}Histórico de Pedidos - GestãoPRO{% endblock %}

{% block content %}
<header class="main-header">
    <h1>Histórico de Pedidos (AOCS)</h1>
    <p class="subtitle">Visualize e acompanhe todos os pedidos registrados no sistema.</p>
</header>

<div class="actions-bar" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    
    <div>
        </div>

    <div class="dropdown" style="position: relative; display: inline-block;">
        <button class="btn btn-primary" type="button" id="btnRelatorios" onclick="toggleDropdown()" style="background-color: #6c757d; border-color: #6c757d;">
            <i class="fa-solid fa-print"></i> Relatórios de AOCS <i class="fa-solid fa-caret-down"></i>
        </button>
        <div id="dropdownRelatorios" class="dropdown-content" style="display: none; position: absolute; right: 0; background-color: #f9f9f9; min-width: 220px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 4px;">
            <a href="{{ request.app.url_path_for('imprimir_lista_aocs') }}?filtro=todos" target="_blank" style="color: black; padding: 12px 16px; text-decoration: none; display: block;">
                <i class="fa-solid fa-list"></i> Listar Todas
            </a>
            <a href="{{ request.app.url_path_for('imprimir_lista_aocs') }}?filtro=pendentes" target="_blank" style="color: black; padding: 12px 16px; text-decoration: none; display: block;">
                <i class="fa-solid fa-clock"></i> Listar Pendentes/Parciais
            </a>
        </div>
    </div>
</div>

<script>
function toggleDropdown() {
  var d = document.getElementById("dropdownRelatorios");
  if (d.style.display === "none") {
    d.style.display = "block";
  } else {
    d.style.display = "none";
  }
}

// Fecha o dropdown se clicar fora
window.onclick = function(event) {
  if (!event.target.matches('#btnRelatorios') && !event.target.matches('#btnRelatorios i')) {
    var dropdowns = document.getElementsByClassName("dropdown-content");
    for (var i = 0; i < dropdowns.length; i++) {
      var openDropdown = dropdowns[i];
      if (openDropdown.style.display === "block") {
        openDropdown.style.display = "none";
      }
    }
  }
}
</script>

<div class="card full-width">
    {% include '_pedidos_filter_bar.html' %}

    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th class="sortable-header">
                        {% set next_order_aocs = 'asc' if sort_by == 'aocs' and order == 'desc' else 'desc' %}
                        {% set params_aocs = query_params.copy() %}
                        {% set _ = params_aocs.update({'sort_by': 'aocs', 'order': next_order_aocs}) %}
                        {% set base_path_aocs = request.app.url_path_for('pedidos_ui') %}
                        {% set query_parts_aocs = [] %}{% for key, value in params_aocs.items() if value is not none and value != '' %}{% set _ = query_parts_aocs.append(key ~ '=' ~ (value|string)) %}{% endfor %}{% set query_string_aocs = "?" ~ (query_parts_aocs | join('&')) if query_parts_aocs else "" %}
                        <a href="{{ base_path_aocs }}{{ query_string_aocs }}">Nº AOCS {% if sort_by == 'aocs' %}<i class="fa-solid {{ 'fa-arrow-down-z-a' if order == 'desc' else 'fa-arrow-up-a-z' }}"></i>{% endif %}</a>
                    </th>
                    <th>Nº Pedido</th>
                    <th class="sortable-header">
                        {% set next_order_forn = 'asc' if sort_by == 'fornecedor' and order == 'desc' else 'asc' %} 
                        {% set params_forn = query_params.copy() %}
                        {% set _ = params_forn.update({'sort_by': 'fornecedor', 'order': next_order_forn}) %}
                        {% set base_path_forn = request.app.url_path_for('pedidos_ui') %}
                        {% set query_parts_forn = [] %}{% for key, value in params_forn.items() if value is not none and value != '' %}{% set _ = query_parts_forn.append(key ~ '=' ~ (value|string)) %}{% endfor %}{% set query_string_forn = "?" ~ (query_parts_forn | join('&')) if query_parts_forn else "" %}
                        <a href="{{ base_path_forn }}{{ query_string_forn }}">Fornecedor {% if sort_by == 'fornecedor' %}<i class="fa-solid {{ 'fa-arrow-down-z-a' if order == 'desc' else 'fa-arrow-up-a-z' }}"></i>{% endif %}</a>
                    </th>
                    <th class="sortable-header text-right"> 
                        {% set next_order_valor = 'asc' if sort_by == 'valor' and order == 'desc' else 'desc' %}
                        {% set params_valor = query_params.copy() %}
                        {% set _ = params_valor.update({'sort_by': 'valor', 'order': next_order_valor}) %}
                        {% set base_path_valor = request.app.url_path_for('pedidos_ui') %}
                        {% set query_parts_valor = [] %}{% for key, value in params_valor.items() if value is not none and value != '' %}{% set _ = query_parts_valor.append(key ~ '=' ~ (value|string)) %}{% endfor %}{% set query_string_valor = "?" ~ (query_parts_valor | join('&')) if query_parts_valor else "" %}
                        <a href="{{ base_path_valor }}{{ query_string_valor }}">Valor Total (R$) {% if sort_by == 'valor' %}<i class="fa-solid {{ 'fa-arrow-down-1-9' if order == 'desc' else 'fa-arrow-up-9-1' }}"></i>{% endif %}</a>
                    </th>
                    <th class="sortable-header">
                        {% set next_order_data = 'asc' if sort_by == 'data' and order == 'desc' else 'desc' %}
                        {% set params_data = query_params.copy() %}
                        {% set _ = params_data.update({'sort_by': 'data', 'order': next_order_data}) %}
                        {% set base_path_data = request.app.url_path_for('pedidos_ui') %}
                        {% set query_parts_data = [] %}{% for key, value in params_data.items() if value is not none and value != '' %}{% set _ = query_parts_data.append(key ~ '=' ~ (value|string)) %}{% endfor %}{% set query_string_data = "?" ~ (query_parts_data | join('&')) if query_parts_data else "" %}
                        <a href="{{ base_path_data }}{{ query_string_data }}">Data {% if sort_by == 'data' %}<i class="fa-solid {{ 'fa-arrow-down-z-a' if order == 'desc' else 'fa-arrow-up-a-z' }}"></i>{% endif %}</a>
                    </th>
                    <th class="sortable-header text-center"> 
                        {% set next_order_status = 'asc' if sort_by == 'status' and order == 'desc' else 'asc' %} 
                        {% set params_status = query_params.copy() %}
                        {% set _ = params_status.update({'sort_by': 'status', 'order': next_order_status}) %}
                        {% set base_path_status = request.app.url_path_for('pedidos_ui') %}
                        {% set query_parts_status = [] %}{% for key, value in params_status.items() if value is not none and value != '' %}{% set _ = query_parts_status.append(key ~ '=' ~ (value|string)) %}{% endfor %}{% set query_string_status = "?" ~ (query_parts_status | join('&')) if query_parts_status else "" %}
                        <a href="{{ base_path_status }}{{ query_string_status }}">Status da Entrega {% if sort_by == 'status' %}<i class="fa-solid {{ 'fa-arrow-down-z-a' if order == 'desc' else 'fa-arrow-up-a-z' }}"></i>{% endif %}</a>
                    </th>
                    <th class="text-right">Ações</th> 
                </tr>
            </thead>
            <tbody>
                {% if pedidos_lista %}
                    {% for pedido in pedidos_lista %}
                    <tr>
                        <td><strong><a href="{{ request.app.url_path_for('detalhe_pedido', numero_aocs=pedido.numero_aocs) }}">{{ pedido.numero_aocs }}</a></strong></td>
                        <td>{{ pedido.numero_pedido or 'N/A' }}</td>
                        <td>{{ pedido.fornecedor }}</td>
                        <td class="text-right">{{ "%.2f"|format(pedido.valor_total)|replace('.', ',') if pedido.valor_total is not none else '0,00' }}</td>
                        <td>{{ pedido.data_pedido.strftime('%d/%m/%Y') if pedido.data_pedido else 'N/D' }}</td>
                        <td class="text-center"> 
                            {% set status_class = 'gray' %}
                            {% if pedido.status_entrega == 'Entregue' %}{% set status_class = 'green' %}{% endif %}
                            {% if pedido.status_entrega == 'Entrega Parcial' %}{% set status_class = 'orange' %}{% endif %}
                            <span class="status-badge {{ status_class }}">{{ pedido.status_entrega or 'Pendente' }}</span> 
                        </td>
                        <td class="actions-cell text-right"> 
                            <a href="{{ request.app.url_path_for('detalhe_pedido', numero_aocs=pedido.numero_aocs) }}" class="btn-link-action">
                                <i class="fa-solid fa-eye"></i> Ver Detalhes
                            </a>
                            <a href="{{ request.app.url_path_for('imprimir_aocs', numero_aocs=pedido.numero_aocs) }}" class="btn-link-action" target="_blank">
                                <i class="fa-solid fa-print"></i> Imprimir
                            </a>
                        </td>
                    </tr>
                    {% else %} 
                    <tr><td colspan="7"><div class="empty-state mini"><p>Nenhum pedido encontrado para os filtros aplicados.</p></div></td></tr>
                {% endfor %} 
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="card-footer">
        {{ render_pagination(pagina_atual, total_paginas, 'pedidos_ui', query_params=query_params) }}
    </div>
</div>
{% endblock %}